<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Program Ethical</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCwxPY-M6lwt7JLZEeexUrhKVgVZj_enHE",
        authDomain: "data-outlet-pharos.firebaseapp.com",
        projectId: "data-outlet-pharos",
        storageBucket: "data-outlet-pharos.appspot.com",
        messagingSenderId: "651086534605",
        appId: "1:651086534605:web:228339d21beb359a709684",
        measurementId: "G-7FQQZ2K3T0",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://connect-assets.prosple.com/cdn/ff/nDJLhKo3GxHUnuJJLt-cRdMGUAmxDY2NSAzboL84_ec/1700559379/public/styles/scale_and_crop_center_120x120/public/2023-11/Logo-Pharos-Indonesia-200x200-2023.jpg?itok=4-AmM7sn"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background: #f1f3f5;
        font-family: "Roboto", sans-serif;
      }
      .navbar-custom {
        background-color: #0d6efd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.4rem;
        font-weight: bold;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 0 30px rgba(13, 110, 253, 0.15);
        background-color: #ffffff;
        padding: 1.5rem 1.75rem;
      }
      .select2-container--bootstrap4 {
        width: 100% !important;
      }
      h2 {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #0d6efd;
      }
      .form-control,
      .form-select {
        border-radius: 0.5rem;
        padding: 0.55rem 0.9rem;
      }
      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.65rem;
        font-weight: 500;
        border-radius: 0.5rem;
      }
      .btn-primary:hover {
        background-color: #0b5ed7;
      }
      .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-top: 0.1em;
        margin-right: 10px;
        vertical-align: middle;
      }
      ::placeholder {
        color: #bbb !important;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top"
    >
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            fill="white"
            class="bi bi-bar-chart-line-fill"
            viewBox="0 0 16 16"
          >
            <path
              d="M1 13.5a.5.5 0 0 1 .5-.5H15v1H1.5a.5.5 0 0 1-.5-.5zm6-11A.5.5 0 0 1 7.5 3v8a.5.5 0 0 1-1 0V3A.5.5 0 0 1 7 2.5zm4 3A.5.5 0 0 1 11.5 6v5a.5.5 0 0 1-1 0V6A.5.5 0 0 1 11 5.5zm-8 2A.5.5 0 0 1 3.5 8v3a.5.5 0 0 1-1 0V8A.5.5 0 0 1 3 7.5z"
            />
          </svg>
          <span class="text-white">Form Trade Marketing</span>
        </a>

        <!-- Hamburger di kanan -->
        <button
          class="navbar-toggler ms-auto"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu collapsible di kiri -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto mt-2 mt-lg-0">
            <li class="nav-item">
              <a
                class="nav-link text-white"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/"
                >Form Hadiah</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/Form-Pendaftaran-Program-Ethical"
                >Form Ethical</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <h2 class="text-center mb-3 mt-2">
              Form Pengajuan Program Ethical
            </h2>
            <h5 class="fw-bold text-primary mt-1 mb-0 pb-0">Input Data Diri</h5>
            <hr
              class="mx-auto mt-3 mb-3"
              style="border-top: 3px dashed #5f5f5f; width: 100%"
            />
            <form id="ethicalForm">
              <div class="row g-3 align-items-end">
                <div class="col-md-8">
                  <label for="nipEthical" class="form-label">NIP</label>
                  <input
                    type="text"
                    id="nipEthical"
                    class="form-control"
                    placeholder="Masukkan NIP"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    id="searchEthicalBtn"
                  >
                    Check NIP
                  </button>
                </div>

                <div class="col-12">
                  <label class="form-label">Nama</label>
                  <input
                    type="text"
                    id="namaEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Jabatan</label>
                  <input
                    type="text"
                    id="jabatanEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Divisi</label>
                  <input
                    type="text"
                    id="divisiEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-12 mb-2 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    Input Detail Program
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />
                </div>

                <div class="col-md-6 mt-0 mb-3 mb-md-0">
                  <label for="outletEthical" class="form-label"
                    >Kode Outlet</label
                  >
                  <select id="outletEthical" class="form-select" required>
                    <option value="">Pilih Outlet</option>
                  </select>
                </div>
                <div class="col-md-6 mt-0">
                  <label for="programEthical" class="form-label"
                    >Pilih Program</label
                  >
                  <select id="programEthical" class="form-select" required>
                    <option value="">Pilih Program</option>
                    <option value="Program Boost Metabolic">
                      Program Boost Metabolic
                    </option>
                    <option value="Program Insentif SC Modafil & Rozgra">
                      Program Insentif SC Modafil & Rozgra
                    </option>
                    <option value="Program POP">Program POP</option>
                    <option value="Program PGD">Program PGD</option>
                    <option value="Program PK to PBF">Program PK to PBF</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Kode PI</label>
                  <input
                    type="text"
                    id="kodePiEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Nama Outlet</label>
                  <input
                    type="text"
                    id="namaOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Kota</label>
                  <input
                    type="text"
                    id="kotaOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Alamat Outlet</label>
                  <input
                    type="text"
                    id="alamatOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <!-- Tambahan untuk Program Insentif SC Modafil & Rozgra -->
                <div id="jenisHadiahWrapper" class="col-12 d-none">
                  <label class="form-label">Jenis Hadiah</label>
                  <select id="jenisHadiah" class="form-select">
                    <option value="">Pilih Jenis Hadiah</option>
                    <option value="e-wallet">E-Wallet</option>
                    <option value="bank">Transfer Bank</option>
                  </select>
                </div>

                <!-- Detail E-Wallet -->
                <div id="ewalletFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Jenis E-Wallet</label>
                    <select id="jenisEwallet" class="form-select">
                      <option value="">Pilih E-Wallet</option>
                      <option value="Dana">Dana</option>
                      <option value="Gopay">Gopay</option>
                      <option value="Ovo">Ovo</option>
                      <option value="ShopeePay">ShopeePay</option>
                    </select>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">No. Telp Akun</label>
                    <input type="tel" id="noTelpEwallet" class="form-control" />
                  </div>
                  <div class="col-12 mt-3">
                    <label class="form-label">Nama Akun</label>
                    <input
                      type="text"
                      id="namaAkunEwallet"
                      class="form-control"
                    />
                  </div>
                </div>

                <!-- Detail Transfer Bank -->
                <div id="bankFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Nama Bank</label>
                    <input type="text" id="namaBank" class="form-control" />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">No. Rekening</label>
                    <input type="text" id="noRek" class="form-control" />
                  </div>
                  <div class="col-12 mt-3">
                    <label class="form-label">Nama Akun Bank</label>
                    <input type="text" id="namaAkunBank" class="form-control" />
                  </div>
                </div>

                <!-- Tambahan untuk Program POP dan PGD -->
                <div id="popPgdFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Estimasi Tanggal Realisasi</label>
                    <input
                      type="date"
                      id="tanggalRealisasi"
                      class="form-control"
                    />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Jumlah Peserta (Pack)</label>
                    <input
                      type="number"
                      id="jumlahPeserta"
                      class="form-control"
                      min="1"
                    />
                  </div>
                </div>

                <div class="form-check ms-2 mt-3 d-flex align-items-center">
                  <input
                    class="form-check-input me-2 big-checkbox"
                    type="checkbox"
                    id="confirmCheck"
                    required
                  />
                  <label
                    class="form-check-label fw-medium ms-2"
                    for="confirmCheck"
                    style="margin: 0"
                  >
                    <strong>SAYA MENYATAKAN</strong> data yang diisi
                    <strong>SUDAH BENAR</strong>
                  </label>
                </div>

                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100">
                    Submit Data
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbyCfQvH4DUpdzSfHbdcZLrH1xWQSK2fAUgXef2s5KjS65ywawThz7JnJ1u8b_6H_slnog/exec";
      let globalOutletData = {};

      $("#outletEthical").select2({
        theme: "bootstrap4",
        placeholder: "Pilih Outlet",
        allowClear: true,
      });
      $("#programEthical").select2({
        theme: "bootstrap4",
        placeholder: "Pilih Program",
        allowClear: true,
      });

      document
        .getElementById("searchEthicalBtn")
        .addEventListener("click", () => {
          const nip = document.getElementById("nipEthical").value.trim();
          if (!nip)
            return Swal.fire(
              "Perhatian",
              "Harap isi NIP terlebih dahulu.",
              "warning"
            );

          Swal.fire({
            title: "Mencari data...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          fetch(
            `https://data-outlet-pharos-default-rtdb.firebaseio.com/${nip}.json`
          )
            .then((res) => res.json())
            .then((data) => {
              Swal.close();
              console.log("Data yang diterima dari Firebase:", data); // <--- Tambahkan ini

              if (!data || !data.nama)
                return Swal.fire(
                  "Tidak Ditemukan",
                  "Data NIP tidak ditemukan.",
                  "error"
                );

              document.getElementById("namaEthical").value = data.nama || "";
              document.getElementById("jabatanEthical").value =
                data.jabatan || "";
              document.getElementById("divisiEthical").value =
                data.divisi || "";

              const select = document.getElementById("outletEthical");
              select.innerHTML = `<option value="">Pilih Outlet</option>`;
              globalOutletData = {}; // kosongkan dulu

              (data.outlets || []).forEach((outlet) => {
                const kode = outlet.kode; // contoh: "GG000154"
                globalOutletData[kode] = outlet; // simpan sebagai object key:value
                const opt = document.createElement("option");
                opt.value = kode;
                opt.textContent = `${kode}`;
                select.appendChild(opt);
              });
              $("#outletEthical").select2("destroy"); // reset Select2
              $("#outletEthical").select2({
                theme: "bootstrap4",
                placeholder: "Pilih Outlet",
                allowClear: true,
              });
            })
            .catch((err) => {
              console.error("Fetch error:", err); // ✅ optional: log ke console
              Swal.close(); // ✅ FIXED: pastikan loading ditutup jika error
              Swal.fire("Error", "Gagal mengambil data dari server.", "error");
            });
        });

      document
        .getElementById("ethicalForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const nip = document.getElementById("nipEthical").value.trim();
          const outlet = document.getElementById("outletEthical").value;

          if (!nip || !outlet) {
            return Swal.fire(
              "Lengkapi Form",
              "Mohon isi semua field sebelum submit.",
              "warning"
            );
          }

          Swal.fire({
            title: "Menyimpan...",
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
          });

          try {
            const body = {
              nip,
              nama: document.getElementById("namaEthical").value,
              jabatan: document.getElementById("jabatanEthical").value,
              divisi: document.getElementById("divisiEthical").value,
              outlet,
            };

            const res = await fetch(scriptURL, {
              method: "POST",
              body: JSON.stringify(body),
              headers: { "Content-Type": "text/plain;charset=utf-8" },
            });

            Swal.close(); // pastikan ditutup

            if (res.ok) {
              Swal.fire("Berhasil", "Data berhasil disimpan.", "success");
              document.getElementById("ethicalForm").reset();
              $("#outletEthical").val(null).trigger("change");
            } else {
              Swal.fire("Gagal", "Gagal menyimpan data.", "error");
            }
          } catch (error) {
            console.error("Submit error:", error); // log ke console
            Swal.close(); // ✅ TUTUP loading kalau error
            Swal.fire("Gagal", "Terjadi kesalahan pada sistem.", "error");
          }
        });

      $("#outletEthical").on("change", function () {
        const kodeOutlet = this.value;
        if (!kodeOutlet || !globalOutletData[kodeOutlet]) return;
        const data = globalOutletData[kodeOutlet];

        $("#kodePiEthical").val(data.kodePi || "");
        $("#namaOutletEthical").val(data.nama || "");
        $("#kotaOutletEthical").val(data.kota || "");
        $("#alamatOutletEthical").val(data.alamat || "");
      });

      $("#programEthical").on("change", function () {
        const selected = $(this).val();

        // Reset & sembunyikan semuanya dulu
        $("#jenisHadiahWrapper").addClass("d-none");
        $("#ewalletFields").addClass("d-none");
        $("#bankFields").addClass("d-none");
        $("#popPgdFields").addClass("d-none");

        if (selected === "Program Insentif SC Modafil & Rozgra") {
          $("#jenisHadiahWrapper").removeClass("d-none");
        } else if (selected === "Program POP" || selected === "Program PGD") {
          $("#popPgdFields").removeClass("d-none");
        }
      });

      $("#jenisHadiah").on("change", function () {
        const jenis = $(this).val();

        // Sembunyikan dua-duanya dulu
        $("#ewalletFields").addClass("d-none");
        $("#bankFields").addClass("d-none");

        if (jenis === "e-wallet") {
          $("#ewalletFields").removeClass("d-none");
        } else if (jenis === "bank") {
          $("#bankFields").removeClass("d-none");
        }
      });
    </script>
  </body>
</html>
